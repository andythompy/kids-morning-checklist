<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Checklist</title>
    
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Canvas Confetti from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <style>
        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: pan-y;
            position: relative;
            transition: background 1s ease;
        }
        
        /* Weather theme backgrounds */
        body.weather-fine {
            background: linear-gradient(to bottom, #fbbf24 0%, #f59e0b 15%, #fb923c 30%, #f97316 45%, #ec4899 60%, #a855f7 75%, #6366f1 90%, #3b82f6 100%);
        }
        
        body.weather-hot {
            background: linear-gradient(to bottom, #fef08a 0%, #fde047 10%, #facc15 20%, #fb923c 35%, #f97316 50%, #ea580c 65%, #dc2626 80%, #b91c1c 100%);
        }
        
        body.weather-cold {
            background: linear-gradient(to bottom, #e0f2fe 0%, #bae6fd 15%, #7dd3fc 30%, #38bdf8 45%, #0ea5e9 60%, #0284c7 75%, #0369a1 90%, #075985 100%);
        }
        
        body.weather-rain {
            background: linear-gradient(to bottom, #64748b 0%, #475569 20%, #334155 40%, #1e293b 60%, #0f172a 80%, #020617 100%);
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 1;
            pointer-events: none;
            transition: background-image 1s ease;
        }
        
        /* Fine weather - Sunrise */
        body.weather-fine::before {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1280 800"><defs><radialGradient id="sunGlow" cx="50%25" cy="50%25" r="50%25"><stop offset="0%25" style="stop-color:%23fef3c7;stop-opacity:1" /><stop offset="50%25" style="stop-color:%23fcd34d;stop-opacity:0.6" /><stop offset="100%25" style="stop-color:%23fbbf24;stop-opacity:0" /></radialGradient></defs><ellipse cx="640" cy="700" rx="600" ry="200" fill="%23fb923c" opacity="0.3"/><ellipse cx="640" cy="720" rx="500" ry="150" fill="%23f59e0b" opacity="0.4"/><circle cx="640" cy="650" r="100" fill="url(%23sunGlow)"/><circle cx="640" cy="650" r="80" fill="%23fbbf24"/><path d="M 0 750 Q 320 700 640 720 T 1280 750 L 1280 800 L 0 800 Z" fill="%23374151" opacity="0.4"/><path d="M 0 780 Q 320 750 640 770 T 1280 780 L 1280 800 L 0 800 Z" fill="%231f2937" opacity="0.5"/></svg>');
        }
        
        /* Hot weather - Bright sun */
        body.weather-hot::before {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1280 800"><defs><radialGradient id="hotSun" cx="50%25" cy="50%25" r="50%25"><stop offset="0%25" style="stop-color:%23fef08a;stop-opacity:1" /><stop offset="40%25" style="stop-color:%23fde047;stop-opacity:0.8" /><stop offset="100%25" style="stop-color:%23fb923c;stop-opacity:0" /></radialGradient></defs><circle cx="640" cy="250" r="150" fill="url(%23hotSun)"/><circle cx="640" cy="250" r="100" fill="%23fbbf24"/><line x1="640" y1="80" x2="640" y2="150" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><line x1="640" y1="350" x2="640" y2="420" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><line x1="470" y1="250" x2="540" y2="250" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><line x1="740" y1="250" x2="810" y2="250" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><line x1="520" y1="130" x2="570" y2="180" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><line x1="710" y1="320" x2="760" y2="370" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><line x1="760" y1="130" x2="710" y2="180" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><line x1="570" y1="320" x2="520" y2="370" stroke="%23fbbf24" stroke-width="12" stroke-linecap="round"/><path d="M 0 650 Q 160 620 320 650 T 640 650 Q 800 650 960 620 T 1280 650 L 1280 800 L 0 800 Z" fill="%23a16207" opacity="0.3"/></svg>');
        }
        
        /* Cold weather - Snowflakes */
        body.weather-cold::before {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1280 800"><circle cx="200" cy="150" r="3" fill="%23e0f2fe"/><circle cx="400" cy="100" r="4" fill="%23bae6fd"/><circle cx="600" cy="180" r="3" fill="%23e0f2fe"/><circle cx="800" cy="120" r="5" fill="%23bae6fd"/><circle cx="1000" cy="160" r="3" fill="%23e0f2fe"/><circle cx="300" cy="300" r="4" fill="%23bae6fd"/><circle cx="700" cy="280" r="3" fill="%23e0f2fe"/><circle cx="900" cy="350" r="4" fill="%23bae6fd"/><circle cx="150" cy="400" r="3" fill="%23e0f2fe"/><circle cx="500" cy="450" r="5" fill="%23bae6fd"/><circle cx="1100" cy="380" r="3" fill="%23e0f2fe"/><path d="M 0 650 L 0 800 L 1280 800 L 1280 650 Q 960 680 640 650 T 0 650 Z" fill="%23f0f9ff" opacity="0.8"/><circle cx="100" cy="680" r="30" fill="%23f0f9ff" opacity="0.6"/><circle cx="250" cy="700" r="40" fill="%23e0f2fe" opacity="0.7"/><circle cx="450" cy="690" r="35" fill="%23f0f9ff" opacity="0.6"/><circle cx="650" cy="710" r="45" fill="%23e0f2fe" opacity="0.7"/><circle cx="850" cy="695" r="35" fill="%23f0f9ff" opacity="0.6"/><circle cx="1050" cy="705" r="40" fill="%23e0f2fe" opacity="0.7"/><circle cx="1200" cy="690" r="30" fill="%23f0f9ff" opacity="0.6"/></svg>');
        }
        
        /* Rain weather - Rain drops and clouds */
        body.weather-rain::before {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1280 800"><ellipse cx="300" cy="150" rx="80" ry="50" fill="%23475569" opacity="0.8"/><ellipse cx="350" cy="130" rx="70" ry="45" fill="%23334155" opacity="0.9"/><ellipse cx="250" cy="140" rx="60" ry="40" fill="%2364748b" opacity="0.7"/><ellipse cx="700" cy="180" rx="90" ry="55" fill="%23475569" opacity="0.8"/><ellipse cx="760" cy="160" rx="75" ry="48" fill="%23334155" opacity="0.9"/><ellipse cx="640" cy="170" rx="65" ry="42" fill="%2364748b" opacity="0.7"/><ellipse cx="1000" cy="140" rx="85" ry="52" fill="%23475569" opacity="0.8"/><ellipse cx="1060" cy="120" rx="70" ry="45" fill="%23334155" opacity="0.9"/><line x1="280" y1="200" x2="260" y2="280" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="320" y1="210" x2="300" y2="290" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="360" y1="200" x2="340" y2="280" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="680" y1="230" x2="660" y2="310" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="720" y1="240" x2="700" y2="320" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="760" y1="230" x2="740" y2="310" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="980" y1="190" x2="960" y2="270" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="1020" y1="200" x2="1000" y2="280" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="1060" y1="190" x2="1040" y2="270" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="200" y1="350" x2="180" y2="430" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="400" y1="380" x2="380" y2="460" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="600" y1="360" x2="580" y2="440" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="800" y1="390" x2="780" y2="470" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/><line x1="1000" y1="370" x2="980" y2="450" stroke="%2394a3b8" stroke-width="3" opacity="0.6"/></svg>');
        }
        
        body.weather-rain {
            animation: rain-bg 0.3s infinite;
        }
        
        @keyframes rain-bg {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.98; }
        }
        
        .task-item {
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .task-item.completed {
            opacity: 0.35;
            text-decoration: line-through;
            box-shadow: none;
            filter: grayscale(0.5);
        }
        
        .column-complete {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 4px solid #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse-animation {
            animation: pulse 0.5s ease-in-out;
        }
        
        /* Enable smooth scrolling */
        .tasks-scroll {
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }
        
        .tasks-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .tasks-scroll::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        
        .tasks-scroll::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            body {
                touch-action: pan-x pan-y;
            }
            
            #app {
                padding: 0 !important;
            }
            
            /* Header adjustments for mobile */
            .header-mobile {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
                padding: 0.75rem !important;
            }
            
            .header-mobile h1 {
                font-size: 1.25rem !important;
            }
            
            #weather-display {
                width: 100%;
            }
            
            #weather-display > div {
                width: 100%;
                padding: 0.5rem 0.75rem !important;
            }
            
            /* Make columns scroll horizontally */
            #columns-container {
                overflow-x: auto !important;
                overflow-y: hidden !important;
                flex-wrap: nowrap !important;
                justify-content: flex-start !important;
                padding: 0.5rem 0 0.5rem 1rem !important;
                gap: 1rem !important;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
                scroll-padding-left: 1rem;
            }
            
            #columns-container > div {
                min-width: calc(100vw - 3rem) !important;
                flex-shrink: 0 !important;
                scroll-snap-align: start;
            }
            
            /* Add scroll indicator hint */
            #columns-container::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 2rem;
                background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
                pointer-events: none;
            }
        }
        
        /* Tablet landscape - keep desktop layout */
        @media (min-width: 769px) and (max-width: 1024px) and (orientation: landscape) {
            /* Keep desktop layout, just slightly smaller */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 p-4">
    <!-- 
    This file is designed to be hosted on GitHub Pages and deployed via GitHub Actions.
    Single file web app for Google Nest Hub Max (1280x800).
    -->
    
    <div id="app" class="h-full flex flex-col relative z-10">
        <!-- Header with Title and Weather -->
        <div class="header-mobile flex justify-between items-center px-4 py-1.5">
            <!-- Title -->
            <div class="flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-800 drop-shadow-sm">üåÖ Morning Checklist</h1>
            </div>
            
            <!-- Clock -->
            <div id="clock-display" class="hidden md:block flex-grow text-center">
                <span id="clock-time" class="text-3xl font-bold text-gray-700 drop-shadow-sm"></span>
            </div>

            <!-- Weather Display -->
            <div id="weather-display" class="flex-shrink-0">
                <div class="bg-white/80 backdrop-blur-sm rounded-xl px-4 py-1.5 shadow-lg">
                    <div class="flex items-center gap-3">
                        <div id="weather-icon" class="text-2xl"></div>
                        <div class="flex items-center gap-3">
                            <div id="weather-temp" class="text-xl font-bold text-gray-800"></div>
                            <div class="text-left">
                                <div id="weather-range" class="text-xs text-gray-600 leading-tight"></div>
                                <div id="weather-desc" class="text-xs text-gray-500 capitalize leading-tight"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Columns Container -->
        <div id="columns-container" class="flex-1 flex gap-3 justify-start items-stretch overflow-hidden px-3 pb-2">
            <!-- Columns will be dynamically generated here -->
        </div>
    </div>
    
    <!-- Test Weather UI (for development) - Commented out for production -->
    <!-- 
    <div id="test-weather" class="fixed bottom-4 right-4 z-50 bg-white/90 backdrop-blur rounded-lg p-3 shadow-xl">
        <div class="text-xs font-bold mb-2 text-gray-700">Test Weather:</div>
        <div class="flex flex-col gap-1">
            <button onclick="testWeather('fine', 22)" class="px-3 py-1 bg-yellow-400 hover:bg-yellow-500 rounded text-xs font-semibold">‚òÄÔ∏è Fine (22¬∞C)</button>
            <button onclick="testWeather('hot', 35)" class="px-3 py-1 bg-orange-500 hover:bg-orange-600 rounded text-xs font-semibold text-white">üî• Hot (35¬∞C)</button>
            <button onclick="testWeather('cold', 5)" class="px-3 py-1 bg-blue-400 hover:bg-blue-500 rounded text-xs font-semibold text-white">‚ùÑÔ∏è Cold (5¬∞C)</button>
            <button onclick="testWeather('rain', 16)" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-xs font-semibold text-white">üåßÔ∏è Rain (16¬∞C)</button>
            <button onclick="fetchWeather()" class="px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-xs font-semibold text-white mt-1">üåç Real Weather</button>
        </div>
    </div>
    -->

    <script type="module">
        // ===================================================================
        // FIREBASE SETUP
        // ===================================================================
        // Import Firebase SDKs (v9+ modular)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration - Replace with your own credentials
        const firebaseConfig = {
            apiKey: "AIzaSyA-Ip7ztUafSAFQgrJtRbqEvzxkUHleUF8",
            authDomain: "morning-checklist-474ec.firebaseapp.com",
            projectId: "morning-checklist-474ec",
            storageBucket: "morning-checklist-474ec.firebasestorage.app",
            messagingSenderId: "302141204153",
            appId: "1:302141204153:web:53d3cef90f3080a1265d68"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // ===================================================================

        // ===================================================================
        // CONFIGURATION - Easy to edit!
        // ===================================================================
        const CONFIG = {
            // Children - 'id' is used for database keys, 'name' is displayed (can include emojis)
            children: [
                { id: "rose", name: "Rose üåπ" },
                { id: "lucy", name: "Lucy üêª‚Äç‚ùÑÔ∏è" },
                { id: "olive", name: "Olive ü¶Ñ" }
            ],
            tasks: [
                { text: "Get dressed", emoji: "üëï" },
                { text: "Eat breakfast (and clean up)", emoji: "üç≥" },
                { text: "Brush hair", emoji: "üíá" },
                { text: "Brush teeth", emoji: "ü¶∑" },
                { text: "Tidy room", emoji: "üßπ" },
                { text: "Laundry basket", emoji: "üß∫" },
                { text: "Piano practice", emoji: "üéπ" },
                { text: "Individual chores", emoji: "‚ú®" },
                { text: "Pack bag", emoji: "üéí" },
                { text: "Socks & shoes", emoji: "üëü" }
            ],
            // Weather Configuration
            weather: {
                // Location coordinates (Sydney, Australia by default) - change to your location
                // Find your coordinates: https://www.google.com/maps (right-click on map to get coordinates)
                lat: -38.1481736,
                lon: 144.336537
            }
        };
        // ===================================================================

        // Color palette for each child (Rose is purple, Lucy is blue, Olive is pink)
        const COLORS = [
            { bg: 'bg-white', border: 'border-purple-400', hover: 'hover:bg-purple-50', text: 'text-purple-700', checkmark: 'bg-purple-500', columnBg: 'bg-purple-50/80' },
            { bg: 'bg-white', border: 'border-blue-400', hover: 'hover:bg-blue-50', text: 'text-blue-700', checkmark: 'bg-blue-500', columnBg: 'bg-blue-50/80' },
            { bg: 'bg-white', border: 'border-pink-400', hover: 'hover:bg-pink-50', text: 'text-pink-700', checkmark: 'bg-pink-500', columnBg: 'bg-pink-50/80' }
        ];

        // State management
        let state = {};
        const TODAY_KEY = getTodayKey();

        // Get today's date as a key
        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        // Get state key for a task (uses child id, not display name)
        function getStateKey(childId, taskText) {
            return `${childId.toLowerCase()}-${taskText.toLowerCase().replace(/\s+/g, '_').replace(/[()]/g, '')}`;
        }

        // Check if task is completed
        function isTaskCompleted(childId, taskText) {
            const key = getStateKey(childId, taskText);
            return state[key] === true;
        }

        // Toggle task completion (now updates Firestore)
        async function toggleTask(childId, taskText, element, columnElement) {
            const key = getStateKey(childId, taskText);
            const docRef = doc(db, 'checklists', TODAY_KEY);
            const newValue = !state[key];
            const updateData = { [key]: newValue };
            const completionKey = `${childId}_completed_at`;

            if (newValue === true) { // Task is being checked
                const allTasksWillBeComplete = CONFIG.tasks.every(task =>
                    (task.text === taskText) ? true : isTaskCompleted(childId, task.text)
                );

                if (allTasksWillBeComplete && !state[completionKey]) {
                    updateData[completionKey] = new Date().toISOString();
                }
            } else { // Task is being unchecked
                if (state[completionKey]) {
                    // In Firestore, to delete a field, you use a special value
                    // but for simplicity, we'll set it to null and filter it out later.
                    updateData[completionKey] = null;
                }
            }

            // Update Firestore - the onSnapshot listener will handle UI updates
            await setDoc(docRef, updateData, { merge: true });
        }

        // Check column completion and award medals
        function checkColumnCompletion() {
            const MEDALS = ['ü•á', 'ü•à', 'ü•â'];
            const finishers = CONFIG.children
                .map(child => ({ id: child.id, time: state[`${child.id}_completed_at`] }))
                .filter(child => child.time)
                .sort((a, b) => new Date(a.time) - new Date(b.time));

            CONFIG.children.forEach(child => {
                const columnElement = document.getElementById(`column-${child.id}`);
                if (!columnElement) return;

                const rank = finishers.findIndex(finisher => finisher.id === child.id);
                const isComplete = rank !== -1;
                const wasComplete = columnElement.classList.contains('column-complete');
                const badge = columnElement.querySelector('.completion-badge');

                if (isComplete) {
                    badge.textContent = MEDALS[rank] || '‚úÖ';
                    badge.classList.remove('hidden');
                    columnElement.classList.add('column-complete');

                    if (!wasComplete) {
                        columnElement.classList.add('pulse-animation');
                        triggerConfetti(columnElement);
                        setTimeout(() => columnElement.classList.remove('pulse-animation'), 500);
                    }
                } else {
                    badge.classList.add('hidden');
                    columnElement.classList.remove('column-complete');
                }
            });
        }

        // Trigger confetti celebration
        function triggerConfetti(columnElement) {
            const rect = columnElement.getBoundingClientRect();
            const x = (rect.left + rect.width / 2) / window.innerWidth;
            const y = (rect.top + rect.height / 2) / window.innerHeight;

            // Fire confetti from the column position
            const count = 200;
            const defaults = {
                origin: { x, y },
                spread: 100,
                ticks: 200,
                gravity: 1,
                decay: 0.94,
                startVelocity: 30,
            };

            // Multiple bursts for effect
            confetti({
                ...defaults,
                particleCount: count * 0.25,
                scalar: 1.2,
            });
            confetti({
                ...defaults,
                particleCount: count * 0.2,
                scalar: 0.75,
            });
            confetti({
                ...defaults,
                particleCount: count * 0.35,
                scalar: 1,
            });
            confetti({
                ...defaults,
                particleCount: count * 0.2,
                scalar: 0.5,
            });
        }

        // Create a task element
        function createTaskElement(childId, childName, task, colorScheme) {
            const isCompleted = isTaskCompleted(childId, task.text);
            
            const taskDiv = document.createElement('div');
            taskDiv.className = `task-item ${colorScheme.bg} border-2 ${colorScheme.border} rounded-lg p-2 cursor-pointer ${colorScheme.hover} flex items-center gap-2 ${isCompleted ? 'completed' : ''}`;
            
            taskDiv.innerHTML = `
                <div class="checkmark ${colorScheme.checkmark} text-white rounded-full w-7 h-7 flex items-center justify-center font-bold text-base flex-shrink-0 ${isCompleted ? '' : 'hidden'}">
                    ‚úì
                </div>
                <div class="text-2xl flex-shrink-0">${task.emoji}</div>
                <div class="flex-1 text-lg font-semibold text-gray-700">
                    ${task.text}
                </div>
            `;
            
            return taskDiv;
        }

        // Create a column for a child
        function createColumn(child, index) {
            const colorScheme = COLORS[index % COLORS.length];
            
            const column = document.createElement('div');
            column.className = `flex-1 ${colorScheme.columnBg} backdrop-blur-sm border-3 ${colorScheme.border} rounded-2xl p-2.5 shadow-xl flex flex-col transition-all duration-300`;
            column.id = `column-${child.id}`;
            
            // Header
            const header = document.createElement('div');
            header.className = 'mb-1.5 text-center relative';
            header.innerHTML = `
                <h2 class="text-2xl font-bold ${colorScheme.text}">${child.name}</h2>
                <div class="completion-badge hidden absolute -top-1 -right-1 bg-green-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl shadow-lg">
                </div>
            `;
            column.appendChild(header);
            
            // Tasks container with scrolling enabled
            const tasksContainer = document.createElement('div');
            tasksContainer.className = 'flex-1 space-y-1.5 tasks-scroll';
            
            CONFIG.tasks.forEach(task => {
                const taskElement = createTaskElement(child.id, child.name, task, colorScheme);
                taskElement.addEventListener('click', (e) => {
                    // Prevent click during scroll
                    if (e.target.closest('.tasks-scroll').dataset.scrolling !== 'true') {
                        toggleTask(child.id, task.text, taskElement, column);
                    }
                });
                tasksContainer.appendChild(taskElement);
            });
            
            // Track scrolling to prevent accidental clicks
            let scrollTimeout;
            tasksContainer.addEventListener('scroll', () => {
                tasksContainer.dataset.scrolling = 'true';
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    tasksContainer.dataset.scrolling = 'false';
                }, 150);
            });
            
            column.appendChild(tasksContainer);
            
            return column;
        }

        // Weather functionality
        function getWeatherTheme(temp, condition) {
            // Determine weather theme based on temperature and conditions
            if (condition.includes('rain') || condition.includes('drizzle') || condition.includes('thunderstorm')) {
                return 'rain';
            } else if (temp >= 30) {
                return 'hot';
            } else if (temp <= 10) {
                return 'cold';
            } else {
                return 'fine';
            }
        }

        function getWeatherEmoji(condition) {
            const conditionLower = condition.toLowerCase();
            if (conditionLower.includes('clear')) return '‚òÄÔ∏è';
            if (conditionLower.includes('cloud')) return '‚òÅÔ∏è';
            if (conditionLower.includes('rain')) return 'üåßÔ∏è';
            if (conditionLower.includes('drizzle')) return 'üå¶Ô∏è';
            if (conditionLower.includes('thunder')) return '‚õàÔ∏è';
            if (conditionLower.includes('snow')) return '‚ùÑÔ∏è';
            if (conditionLower.includes('mist') || conditionLower.includes('fog')) return 'üå´Ô∏è';
            return 'üå§Ô∏è';
        }

        function updateWeatherDisplay(temp, minTemp, maxTemp, description, theme) {
            document.getElementById('weather-temp').textContent = `${Math.round(temp)}¬∞C`;
            document.getElementById('weather-range').textContent = `${Math.round(minTemp)}¬∞C - ${Math.round(maxTemp)}¬∞C`;
            document.getElementById('weather-desc').textContent = description;
            document.getElementById('weather-icon').textContent = getWeatherEmoji(description);
            
            // Update theme
            document.body.className = `weather-${theme}`;
        }

        async function fetchWeather() {
            try {
                // Using Open-Meteo API (completely free, no API key needed)
                // Documentation: https://open-meteo.com/
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.weather.lat}&longitude=${CONFIG.weather.lon}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }
                
                const data = await response.json();
                const temp = data.current.temperature_2m;
                const minTemp = data.daily.temperature_2m_min[0];
                const maxTemp = data.daily.temperature_2m_max[0];
                const weatherCode = data.current.weather_code;
                
                // Convert WMO weather code to description and condition
                const weatherInfo = getWeatherInfoFromCode(weatherCode);
                const theme = getWeatherTheme(temp, weatherInfo.condition.toLowerCase());
                updateWeatherDisplay(temp, minTemp, maxTemp, weatherInfo.description, theme);
                
            } catch (error) {
                console.error('Failed to fetch weather:', error);
                // Fallback to default fine weather
                updateWeatherDisplay(22, 18, 26, 'pleasant day', 'fine');
            }
        }

        // Convert WMO weather codes to descriptions
        // Reference: https://open-meteo.com/en/docs
        function getWeatherInfoFromCode(code) {
            const weatherCodes = {
                0: { description: 'clear sky', condition: 'Clear' },
                1: { description: 'mainly clear', condition: 'Clear' },
                2: { description: 'partly cloudy', condition: 'Clouds' },
                3: { description: 'overcast', condition: 'Clouds' },
                45: { description: 'foggy', condition: 'Fog' },
                48: { description: 'depositing rime fog', condition: 'Fog' },
                51: { description: 'light drizzle', condition: 'Drizzle' },
                53: { description: 'moderate drizzle', condition: 'Drizzle' },
                55: { description: 'dense drizzle', condition: 'Drizzle' },
                56: { description: 'light freezing drizzle', condition: 'Drizzle' },
                57: { description: 'dense freezing drizzle', condition: 'Drizzle' },
                61: { description: 'slight rain', condition: 'Rain' },
                63: { description: 'moderate rain', condition: 'Rain' },
                65: { description: 'heavy rain', condition: 'Rain' },
                66: { description: 'light freezing rain', condition: 'Rain' },
                67: { description: 'heavy freezing rain', condition: 'Rain' },
                71: { description: 'slight snow fall', condition: 'Snow' },
                73: { description: 'moderate snow fall', condition: 'Snow' },
                75: { description: 'heavy snow fall', condition: 'Snow' },
                77: { description: 'snow grains', condition: 'Snow' },
                80: { description: 'slight rain showers', condition: 'Rain' },
                81: { description: 'moderate rain showers', condition: 'Rain' },
                82: { description: 'violent rain showers', condition: 'Rain' },
                85: { description: 'slight snow showers', condition: 'Snow' },
                86: { description: 'heavy snow showers', condition: 'Snow' },
                95: { description: 'thunderstorm', condition: 'Thunderstorm' },
                96: { description: 'thunderstorm with slight hail', condition: 'Thunderstorm' },
                99: { description: 'thunderstorm with heavy hail', condition: 'Thunderstorm' }
            };
            
            return weatherCodes[code] || { description: 'unknown', condition: 'Clear' };
        }

        // Test weather function for development
        function testWeather(theme, temp) {
            const descriptions = {
                fine: 'clear sky',
                hot: 'sunny and hot',
                cold: 'clear and cold',
                rain: 'light rain'
            };
            const minTemp = temp - 4;
            const maxTemp = temp + 4;
            updateWeatherDisplay(temp, minTemp, maxTemp, descriptions[theme], theme);
        }

        // Setup Firestore real-time listener
        function setupFirestoreListener() {
            const docRef = doc(db, 'checklists', TODAY_KEY);
            
            onSnapshot(docRef, async (docSnap) => {
                if (docSnap.exists()) {
                    // Document exists, load the state
                    state = docSnap.data();
                } else {
                    // First time today, create empty document
                    state = {};
                    await setDoc(docRef, {});
                }
                
                // Update the UI to reflect the state
                updateUIFromState();
            });
        }

        // Update UI based on current state
        function updateUIFromState() {
            CONFIG.children.forEach((child, index) => {
                const columnElement = document.getElementById(`column-${child.id}`);
                if (!columnElement) return;
                
                CONFIG.tasks.forEach((task) => {
                    const key = getStateKey(child.id, task.text);
                    const isCompleted = state[key] === true;
                    
                    // Find the task element in the DOM
                    const tasksContainer = columnElement.querySelector('.tasks-scroll');
                    if (!tasksContainer) return;
                    
                    // Find task by matching text content
                    const taskElements = tasksContainer.querySelectorAll('.task-item');
                    taskElements.forEach(taskElement => {
                        const taskTextElement = taskElement.querySelector('.flex-1');
                        if (taskTextElement && taskTextElement.textContent.trim() === task.text) {
                            const checkmark = taskElement.querySelector('.checkmark');
                            
                            if (isCompleted) {
                                taskElement.classList.add('completed');
                                if (checkmark) checkmark.classList.remove('hidden');
                            } else {
                                taskElement.classList.remove('completed');
                                if (checkmark) checkmark.classList.add('hidden');
                            }
                        }
                    });
                });
            });

            // Re-check column completion for all columns
            checkColumnCompletion();
        }

        // Clock functionality
        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = (hours % 12) || 12; // Convert to 12-hour format

            const timeString = `${formattedHours}:${minutes}:${seconds} ${ampm}`;
            const clockElement = document.getElementById('clock-time');
            if (clockElement) {
                clockElement.textContent = timeString;
            }
        }

        // Make testWeather available globally for the test buttons
        window.testWeather = testWeather;
        window.fetchWeather = fetchWeather;

        // Initialize the app (now async)
        async function init() {
            try {
                // Sign in anonymously to Firebase
                console.log('Attempting to sign in to Firebase...');
                await signInAnonymously(auth);
                console.log('‚úì Signed in to Firebase anonymously');
                
                // Build the UI
                const container = document.getElementById('columns-container');
                
                CONFIG.children.forEach((child, index) => {
                    const column = createColumn(child, index);
                    container.appendChild(column);
                });
                
                // Setup Firestore listener after UI is built
                console.log('Setting up Firestore listener...');
                setupFirestoreListener();
                
                // On mobile, scroll to show first column properly
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        container.scrollLeft = 0;
                    }, 100);
                }
                
                // Fetch weather on load
                fetchWeather();
                
                // Update clock every second
                updateClock();
                setInterval(updateClock, 1000);

                // Refresh weather every 30 minutes
                setInterval(fetchWeather, 30 * 60 * 1000);
            } catch (error) {
                console.error('‚ùå Error initializing app:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                if (error.code === 'auth/configuration-not-found') {
                    console.error('\n‚ö†Ô∏è SETUP REQUIRED:');
                    console.error('1. Go to Firebase Console ‚Üí Authentication');
                    console.error('2. Enable Anonymous sign-in method');
                    console.error('3. Refresh this page');
                }
                
                alert('Firebase setup incomplete. Check console for details. See FIREBASE_SETUP.md for instructions.');
            }
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
